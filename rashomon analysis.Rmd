---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(grf)
library(ggforce)

source("distilled_causal_tree.R")
```
```{r}
# source('predict_fn.R')
data_full <- readRDS('data.rds')
set.seed(30)
```

```{r}
X <- data_full$X
Y <- data_full$Y
W <- data_full$W
weights <- data_full$weights
w_hat <- data_full$What
y_hat <- data_full$Yhat
X_id <- data_full$Xid
```

```{r}

# 10000 tree causal forest for benchmark
t100000 <- causal_forest(X, 
                         Y, 
                         W,
                         Y.hat = y_hat,
                         W.hat = w_hat,
                         sample.weights = weights,
                         num.trees = 50000)

# 10000 tree causal forest for benchmark
t10000 <- causal_forest(X, 
                         Y, 
                         W,
                         Y.hat = y_hat,
                         W.hat = w_hat,
                         sample.weights = weights,
                         num.trees = 10000)

# 1000 tree causal forest
t1000 <- causal_forest(X, 
                         Y, 
                         W,
                         Y.hat = y_hat,
                         W.hat = w_hat,
                         sample.weights = weights,
                         num.trees = 1000)

# 100 tree causal forest
t100 <- causal_forest(X, 
                         Y, 
                         W,
                         Y.hat = y_hat,
                         W.hat = w_hat,
                         sample.weights = weights,
                         num.trees = 100)

# 10 tree causal forest
t10 <- causal_forest(X, 
                         Y, 
                         W,
                         Y.hat = y_hat,
                         W.hat = w_hat,
                         sample.weights = weights,
                         num.trees = 10)

# 2 tree causal forest
t1 <- causal_forest(X, 
                         Y, 
                         W,
                         Y.hat = y_hat,
                         W.hat = w_hat,
                         sample.weights = weights,
                         num.trees = 1,
                        ci.group.size = 1)


# # Causal tree with unlimited depth
# t1 <- causal_forest(t10000 %>% get_tree(70), 
#                          y_hat, 
#                          w_hat,
#                          sample.weights = data_s$uhhwte)
# 
# # Causal tree with minsize = 50
# t1_lim <- causal_forest(X, 
#                          Y %>% missMethods::impute_median() %>% pull(), 
#                          W %>% missMethods::impute_median() %>% pull,
#                          Y.hat = y_hat,
#                          W.hat = w_hat,
#                          sample.weights = data_s$uhhwte,
#                          num.trees = 10000)


```

```{r}
losses <- data.frame(
  t10000 = (t100000$prediction - t10000$predictions) / t100000$prediction,
  t1000 = (t100000$prediction - t1000$predictions) / t100000$prediction,
  t100 = (t100000$prediction - t100$predictions) / t100000$prediction,
  t10 = (t100000$prediction - t10$predictions) / t100000$prediction,
  t1 = (t100000$prediction - t1$predictions) / t100000$prediction
)
```

```{r}
losses %>%
  mutate_all(abs) %>%
  gather("Number of trees", "Absolute loss") %>%
  mutate(`Number of trees` = factor(`Number of trees`,
                                    levels = c("t1", "t10", "t100", "t1000", "t10000"),
                                    labels = c("1", "10", "100", "1000", "10000"))) %>%
  ggplot(aes(x = `Number of trees`, y = `Absolute loss`)) +
    geom_jitter(alpha = 0.2) +
    stat_summary(fun=mean, geom="line", aes(group=1), color ="red", size=2) +
    facet_zoom(ylim = c(0, 0.5))

ggsave('loss_graph.png')
```

```{r}
library(ggforce)
losses %>%
  mutate_all(abs) %>%
  gather("Number of trees", "Absolute loss") %>%
  mutate(`Number of trees` = factor(`Number of trees`,
                                    levels = c("t1", "t10", "t100", "t1000", "t10000"),
                                    labels = c("1", "10", "100", "1000", "10000"))) %>%
  ggplot(aes(x = `Number of trees`, y = `Absolute loss`)) +
    geom_jitter(alpha = 0.2) +
    stat_summary(fun=mean, geom="line", aes(group=1), color ="red", size=2)
```

# Distillation

```{r}
het_forest_results <- distilled_causal_tree(t100000, seed = 3, num_candidate_trees = 1000, replicates = 2000, maxdepth = 3)
```

```{r}
best_treat_results <- het_forest_results$estimates  %>%
  mutate(est = round(est, 3), se = round(se, 3)) %>%
  arrange(as.numeric(node))

best_treat_results
```


